# Grafana 儀表板分析指南

本指南說明如何閱讀與分析 Grafana 儀表板（包含公開儀表板），協助你快速判讀系統狀態並找出問題。

## 目錄

1. [理解儀表板結構](#理解儀表板結構)
2. [解讀視覺化](#解讀視覺化)
3. [分析指標](#分析指標)
4. [辨識問題](#辨識問題)
5. [公開儀表板分析](#公開儀表板分析)
6. [案例研究](#案例研究)

## 理解儀表板結構

### 核心構成

每個 Grafana 儀表板通常包含：

#### 1. 儀表板頁首
- **標題**：監控對象與目的
- **標籤**：分類（如 monitoring、production、mysql）
- **時間範圍選擇器**：控制顯示期間
- **重新整理按鈕**：手動更新
- **自動更新**：設定更新頻率
- **分享按鈕**：匯出、快照或公開分享

#### 2. 變數（篩選器）
位於儀表板上方：
- **下拉選單**：依伺服器、區域或環境篩選
- **輸入框**：搜尋或動態篩選
- **動態值**：依資料變化更新

範例變數：
```
Server: [web-01] [web-02] [db-01]
Environment: [production] [staging] [development]
```

#### 3. Row（列）
用於分組面板：
- 可展開/收合
- 適合組織相近指標（概覽、細節、日誌）

#### 4. Panel（面板）
展示單一或一組指標的視覺化：
- 圖表、Stat、Table、Gauge 等
- 含標題、描述與資料來源
- 可設定圖例與座標軸

### 版面配置模式

#### 模式 1：概覽 → 細節 → 日誌
```
Row 1: 高階指標（CPU、記憶體、磁碟）
Row 2: 詳細時間序列
Row 3: 最近日誌與事件
```

#### 模式 2：問題 → 指標 → 日誌
```
Row 1: 當前問題與告警
Row 2: 主要效能指標
Row 3: 錯誤與警告日誌
```

#### 模式 3：商業指標
```
Row 1: KPI（營收、使用者、轉換率）
Row 2: 趨勢變化
Row 3: 地理分布
```

## 解讀視覺化

### 時間序列圖

**觀察重點：**
- **趨勢**：上升、下降或穩定
- **規律**：日/週期性的波動
- **異常**：突增或突降
- **關聯**：多個指標是否同步變化

**範例分析：**
```
CPU 使用率圖：
- 基準：40-50%（正常）
- 規律：工作時間上升（9am-5pm）
- 尖峰：2pm 突升到 95%（需進一步調查）
- 趨勢：數週逐漸上升（需容量規劃）
```

### Stat 面板（單一數值）

**觀察重點：**
- **目前值**：是否在正常範圍
- **顏色**：綠色（良好）、黃色（警告）、紅色（嚴重）
- **小趨勢圖**：短期走勢
- **比較**：與前一周期差異

**範例分析：**
```
目前回應時間：250ms（紅色）
- 超過 200ms 閾值
- 趨勢呈上升
- 行動：檢查慢查詢
```

### Gauge

**觀察重點：**
- **指針位置**：目前落在哪個區間
- **閾值顏色**：綠/黃/紅
- **百分比**：資源使用程度

**範例分析：**
```
磁碟使用率 Gauge：85%（黃色）
- 接近紅色區（90%）
- 行動：規劃清理或擴容
```

### Table

**觀察重點：**
- **排序欄位**：目前最重要的排序依據
- **色彩提示**：關鍵值是否被突出
- **模式**：是否有重複錯誤或共同來源

**範例分析：**
```
錯誤日誌表：
- 多數錯誤來自 payment-service
- DB_TIMEOUT 出現頻繁
- 行動：檢查資料庫連線池
```

### Bar Chart

**觀察重點：**
- **比較**：最高/最低
- **分布**：是否集中
- **離群值**：是否有異常高的欄位

**範例分析：**
```
Top 10 Pages：
- 首頁佔 80% 流量
- 產品頁面偏低
- 行動：改善產品頁曝光
```

### Heatmap

**觀察重點：**
- **熱點**：色彩最密集區
- **模式**：時間分布是否有規律
- **分散程度**：是否集中在少數區域

**範例分析：**
```
延遲 Heatmap：
- 大多在 50-100ms（正常）
- 下午 2-3pm 出現 500ms+ 熱點
- 行動：調查尖峰負載
```

## 分析指標

### 4 個黃金訊號（SRE）

分析系統儀表板時，先看：

#### 1. 延遲（Latency）
**定義**：處理請求所需時間
**觀察：**
- 平均值、P50、P95、P99
- 長期趨勢
- 高負載期間的變化

**良好**：穩定且低
**不佳**：持續上升或高百分位

#### 2. 流量（Traffic）
**定義**：系統負載需求
**觀察：**
- 每秒請求數
- 活躍使用者數
- 資料傳輸量

**良好**：可預期的波動
**不佳**：突增或突降

#### 3. 錯誤（Errors）
**定義**：失敗或異常的請求
**觀察：**
- 錯誤率
- 錯誤種類
- 影響的服務

**良好**：低且穩定
**不佳**：持續上升或出現新錯誤

#### 4. 飽和度（Saturation）
**定義**：系統接近上限的程度
**觀察：**
- CPU、記憶體、磁碟
- Queue 長度
- 連線池使用率

**良好**：遠離上限
**不佳**：接近或超過上限

### USE 方法（資源）

適用於 CPU/記憶體/磁碟：

#### Utilization（使用率）
- 資源使用比例
- 觀察時間平均

#### Saturation（飽和度）
- 排隊深度、等待時間

#### Errors（錯誤）
- 錯誤事件數
- 失敗操作

### RED 方法（服務）

適用於微服務與 API：

#### Rate（速率）
- 每秒請求數

#### Errors（錯誤）
- 失敗請求數
- 錯誤率百分比

#### Duration（延遲）
- 回應時間分佈

### 補充：觀察一致性
- 跨資料來源的指標是否一致
- 同一時間範圍內各面板是否同步
- 變數切換後是否合理變化

## 辨識問題

### 常見模式與意義

#### 1. 突然尖峰
```
模式：指標突然暴衝再回落
可能原因：
- 佈署/重啟
- 流量激增
- 批次作業
- 攻擊/濫用
行動：查看尖峰時段日誌
```

#### 2. 緩慢上升
```
模式：數日或數週持續上升
可能原因：
- 使用者成長
- 記憶體洩漏
- 資料累積
行動：容量規劃與排查
```

#### 3. 週期性波動
```
模式：固定高峰與低谷
可能原因：
- 上班時間流量
- 排程工作
- 備份作業
行動：確認是否為預期行為
```

#### 4. 突然降為零
```
模式：指標變 0 並維持
可能原因：
- 服務故障
- 監控中斷
- 設定變更
行動：立即檢查服務
```

#### 5. 波動增加
```
模式：值變得更不穩定
可能原因：
- 效能不一致
- 資源競爭
- 網路問題
行動：檢查系統穩定性
```

### 告警顏色意義

- 🟢 **綠色**：正常
- 🟡 **黃色**：警告，需注意
- 🔴 **紅色**：嚴重，需立即處理
- ⚫ **灰色**：無資料或停用

### 關聯分析

當問題出現時，先看指標間關聯：

```
高 CPU + 回應變慢 = 處理瓶頸
高記憶體 + 請求增加 = 可能記憶體洩漏
高磁碟 I/O + 慢查詢 = 資料庫效能問題
錯誤暴增 + 佈署時間 = 可能不良版本
```

## 公開儀表板分析

分析公開儀表板（如分享連結）時：

### Step 1：確認目的

**問題清單：**
- 監控哪個系統或應用？
- 目標受眾是誰？
- 關鍵指標有哪些？

### Step 2：檢查時間範圍

- **最近 24 小時**：即時監控
- **最近 7 天**：趨勢分析
- **最近 30 天**：容量規劃
- **自訂範圍**：事件追蹤

### Step 3：分析每個面板

對每個視覺化面板檢視：

1. **測量的是什麼？**
2. **現在數值代表什麼？**
3. **趨勢如何？**
4. **有沒有異常？**

### Step 4：找出關聯

- 指標是否同步變化？
- 錯誤是否與高負載同時發生？
- 是否與事件或佈署時間對齊？

### Step 5：下結論

- **目前狀態**：健康/退化/危急
- **趨勢**：改善或惡化
- **行動**：立即或計畫處理

## 案例研究

### 案例 1：網站效能監控

**儀表板**：網站監控
**時間範圍**：最近 6 小時

**觀察：**
- 回應時間：平均 150ms（正常）
- 錯誤率：0.5%（可接受）
- 流量：1000 req/s（穩定）
- CPU：60%（正常）

**分析：**
✅ 系統健康
✅ 效能符合 SLA
✅ 無需立即行動

**建議：**
- 持續監控
- 觀察每日趨勢
- 預估成長需求

### 案例 2：資料庫壓力過高

**儀表板**：MySQL 監控
**時間範圍**：最近 2 小時

**觀察：**
- CPU：95%（危急）
- 慢查詢：45/分鐘（偏高）
- 連線池：98/100（接近飽和）
- 查詢時間：P95 = 2.5s（危急）

**分析：**
🔴 資料庫處於高壓狀態
🔴 連線池即將耗盡
🔴 查詢效率不佳

**立即行動：**
1. 找出慢查詢
2. 建立索引
3. 提升連線池
4. 考慮讀寫分離

### 案例 3：記憶體洩漏

**儀表板**：應用監控
**時間範圍**：最近 7 天

**觀察：**
- 記憶體逐日上升
- 由 2GB 增至 14GB
- 每日重啟後恢復到 2GB

**分析：**
🔴 明顯記憶體洩漏
🔴 每日增加 ~1.7GB

**根因處理：**
1. 進行記憶體剖析
2. 檢查近期程式碼
3. 確認資源是否釋放

### 案例 4：流量暴增

**儀表板**：API Gateway
**時間範圍**：最近 1 小時

**觀察：**
- 正常：500 req/s
- 尖峰：2:15pm → 5000 req/s
- 持續：5 分鐘
- 錯誤率：1% → 15%

**分析：**
🟡 非預期流量
🟡 錯誤率上升
🟡 系統已恢復

**調查步驟：**
1. 查詢 2:15pm 日誌
2. 檢查流量來源
3. 確認是否有行銷活動
4. 排除攻擊或濫用

## 儀表板分析最佳實務

### 建議 ✅

- **先看概覽**：掌握全局
- **理解背景**：清楚「正常」狀態
- **找出規律**：日/週期波動
- **關聯指標**：觀察互動關係
- **統一時間軸**：避免誤判
- **閱讀描述**：面板說明很重要
- **多資料來源對比**：檢查一致性

### 避免 ❌

- **過早下結論**：先驗證
- **忽略上下文**：尖峰可能是預期
- **只看單一指標**：需關聯分析
- **忽略季節性**：如週末/尖峰
- **忽略小變化**：小變化可能是前兆

## 工具與技巧

### 時間範圍比較

- 當週 vs 前週
- 上班時間 vs 下班時間
- 佈署前 vs 佈署後

### 註解（Annotations）

在圖表上標示：
- 佈署
- 設定變更
- 事件
- 維護時間

### 深入分析（Drill-Down）

- 從概覽切到細節
- 連結至相關儀表板
- 追蹤至日誌或追蹤系統

### 匯出資料

- CSV 匯出
- JSON 下載
- 使用 API 取得指標

## 結論

儀表板分析能力需要練習，重點包含：

1. **先理解結構**再深入
2. **找出趨勢與異常**
3. **使用分析框架**（USE、RED、黃金訊號）
4. **關聯指標**找到根因
5. **建立標準流程**與紀錄

透過這些方法，你可以有效判讀任何 Grafana 儀表板，並提早發現問題與改善方向。

---

## 延伸資源

- [Grafana 最佳實務](https://grafana.com/docs/grafana/latest/best-practices/)
- [SRE 經典書籍](https://sre.google/books/)
- [RED Method](https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/)
- [USE Method](http://www.brendangregg.com/usemethod.html)
- [四大黃金訊號](https://sre.google/sre-book/monitoring-distributed-systems/)

## 練習題

嘗試分析以下情境：

**儀表板**：電商平台
**面板內容**：
- 今日銷售額：$12,450（紅色）
- 活躍使用者：234（綠色）
- 購物車放棄率：78%（紅色）
- 回應時間：450ms（黃色）
- 錯誤率：5%（紅色）

**任務：**
1. 找出問題
2. 判斷緊急程度
3. 建議調查方向
4. 提出改善行動

**範例分析：**
- 銷售額未達標（紅色）
- 放棄率偏高可能是結帳流程問題
- 回應慢可能造成使用者放棄
- 錯誤率高顯示功能異常
- 優先順序：處理錯誤 → 改善效能 → 追蹤銷售回復
